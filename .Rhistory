geom_hline(yintercept = daily_percentiles$Values[3], color="pink") +
geom_hline(yintercept = daily_percentiles$Values[4], color="pink") +
geom_hline(yintercept = daily_percentiles$Values[5], color="pink") +
geom_hline(yintercept = daily_percentiles$Values[6], color="red") +
geom_point(color   = "red",
data    = ams_series,
mapping = aes(x = Date,
y = Discharge)) +
labs(title    = "USGS Stream Discharge Analysis", # Title
subtitle = str_c(station_metadata$station_nm,
" (",
station_metadata$site_no
,")",
sep = ""),
caption  = "magenta lines = 99,95,90,75,50 ptiles; red = mean") +
xlab("Date")            + # Axis Labels
ylab("Discharge (cfs)")
# Plotting the Basic River Discharge Series
ggplot(data    = ams_series,             # Data Frame
mapping = aes(x  =  Discharge)) +
theme_bw() +
geom_density(color = "red") +
geom_line(mapping = aes(y = pdf_gumbel,
x = Discharge),
color = "magenta") +
geom_vline(xintercept = alpha_ams,
color      = "orange") +
labs(title    = "USGS Stream Discharge Analysis", # Title
subtitle = str_c(station_metadata$station_nm,
" (",
station_metadata$site_no
,")",
sep = "")) +
ylab("Probability Density Function, p(x)")            + # Axis Labels
xlab("Discharge (cfs)")
# Plotting the CDFs of the Basic River Discharge Series
number_of_years_in_series = length(unique(hydrologic$Water_Year))
ams_series$CDF_manual = 1 - ams_series$rank / (1 + number_of_years_in_series)
ggplot(data    = ams_series,             # Data Frame
mapping = aes(x  = Discharge)) +
theme_bw() +
stat_ecdf(geom = "line", color="darkgrey")  +
geom_line(mapping = aes( x = Discharge,
y = CDF_manual),
color="red") +
geom_line(mapping = aes( x = Discharge,
y = CDF_gumbel),
color="magenta") +
xlab("Annual Max Discharge (cfs)") +
ylab("CDF(x) or P(x<X)") +
labs(title    = "USGS Stream Discharge Analysis", # Title
subtitle = str_c(station_metadata$station_nm,
" (",
station_metadata$site_no
,")",
sep = "")) +
scale_y_continuous(sec.axis = sec_axis(trans=~ 1 - .,name="Survival Function = P(x>X)"))
#
# Calculate return intervals
#
number_of_years_in_series = length(unique(hydrologic$Water_Year))
ams_series$T_manual = (1+number_of_years_in_series)/ams_series$rank
ams_series$T_gumbel = 1/(1-ams_series$CDF_gumbel)
ggplot(data    = ams_series,             # Data Frame
mapping = aes(y  =  Discharge,
x  =  T_manual)) +
xlim(0,max(ams_series$T_manual)) +
theme_bw() +
geom_point(color="red") +
geom_line(color="magenta",
mapping = aes(y = Discharge,
x = T_gumbel)) +
xlab("Excedence Frequency (years)") +
ylab("Discharge (cfs)") +
labs(title    = "USGS Stream Discharge Analysis", # Title
subtitle = str_c(station_metadata$station_nm,
" (",
station_metadata$site_no
,")",
sep = ""))
# Plotting the Basic River Discharge Series
ggplot(data    = hydrologic,             # Data Frame
mapping = aes(x  =  Date,         # Mapping of Aesthetics
y  =  Discharge)) +
theme_bw() +
geom_line(color = "blue") +
geom_hline(yintercept = daily_percentiles$Values[1], color="pink") +
geom_hline(yintercept = daily_percentiles$Values[2], color="pink") +
geom_hline(yintercept = daily_percentiles$Values[3], color="pink") +
geom_hline(yintercept = daily_percentiles$Values[4], color="pink") +
geom_hline(yintercept = daily_percentiles$Values[5], color="pink") +
geom_hline(yintercept = daily_percentiles$Values[6], color="red") +
geom_point(color   = "red",
data    = ams_series,
mapping = aes(x = Date,
y = Discharge)) +
labs(title    = "USGS Stream Discharge Analysis", # Title
subtitle = str_c(station_metadata$station_nm,
" (",
station_metadata$site_no
,")",
sep = ""),
caption  = "magenta lines = 99,95,90,75,50 ptiles; red = mean") +
xlab("Date")            + # Axis Labels
ylab("Discharge (cfs)")
threshold = min(ams_series$Discharge)
threshold = quantile(hydrologic$Discharge,
probs = 0.99,
na.rm = TRUE)
# Calculate Annual PDS Series
pds_series = hydrologic          %>%
filter(Discharge > p95_daily)
# Sort and add the rank to the series.
pds_series = pds_series                    %>%
arrange(desc(Discharge))                 %>%
mutate(rank = min_rank(desc(Discharge))) %>%
dplyr::select(rank,
Date,
Discharge,
Water_Year)                       %>%
arrange(Discharge)
number_of_years_in_series = length(unique(hydrologic$Water_Year))
pds_series$CDF_manual =  1 -  pds_series$rank / (1 + nrow(pds_series))
pds_series$T_manual   = (1+number_of_years_in_series)/pds_series$rank
# lets also get the mode as before
alpha_pds  = modeest::mlv(pds_series$Discharge,
method = "meanshift")
# Plotting the Basic River Discharge Series
ggplot(data    = hydrologic,             # Data Frame
mapping = aes(x  =  Date,         # Mapping of Aesthetics
y  =  Discharge)) +
theme_bw() +
geom_line(color = "blue") +
geom_hline(yintercept = daily_percentiles$Values[1], color="pink") +
geom_hline(yintercept = daily_percentiles$Values[2], color="pink") +
geom_hline(yintercept = daily_percentiles$Values[3], color="pink") +
geom_hline(yintercept = daily_percentiles$Values[4], color="pink") +
geom_hline(yintercept = daily_percentiles$Values[5], color="pink") +
geom_hline(yintercept = daily_percentiles$Values[6], color="red") +
geom_point(color   = "darkgreen",
data    = pds_series,
mapping = aes(x = Date,
y = Discharge)) +
geom_point(color   = "red",
size = 0.8,
data    = ams_series,
mapping = aes(x = Date,
y = Discharge)) +
labs(title    = "USGS Stream Discharge Analysis", # Title
subtitle = str_c(station_metadata$station_nm,
" (",
station_metadata$site_no
,")",
sep = ""),
caption  = "magenta lines = 99,95,90,75,50 ptiles; red = mean") +
xlab("Date")            + # Axis Labels
ylab("Discharge (cfs)")
# Plotting the Basic River Discharge Series
ggplot(data    = ams_series,             # Data Frame
mapping = aes(x  =  Discharge)) +
theme_bw() +
geom_density(color = "red") +
geom_line(mapping = aes(y = pdf_gumbel,
x = Discharge),
color = "magenta") +
geom_density(data    = pds_series,
mapping = aes(x = Discharge),
trim    = TRUE,
color   = "darkgreen") +
geom_vline(xintercept = alpha_pds,
color      = "green") +
geom_vline(xintercept = alpha_ams,
color      = "orange") +
labs(title    = "USGS Stream Discharge Analysis", # Title
subtitle = str_c(station_metadata$station_nm,
" (",
station_metadata$site_no
,")",
sep = ""),
caption = "red shades = AMS, greens shades = PDS") +
ylab("Probability Density Function, p(x)")            + # Axis Labels
xlab("Discharge (cfs)")
# Plotting the CDFs of the Basic River Discharge Series
ggplot(data    = ams_series,             # Data Frame
mapping = aes(x  = Discharge)) +
theme_bw() +
stat_ecdf(geom = "line", color="darkgrey",
trim    = TRUE)  +
geom_line(mapping = aes( x = Discharge,
y = CDF_manual),
color="red") +
geom_line(mapping = aes( x = Discharge,
y = CDF_gumbel),
color="magenta") +
stat_ecdf(data = pds_series,
mapping = aes(x  = Discharge),
geom = "line", color="darkgrey",
trim    = TRUE)  +
geom_line(data = pds_series,
mapping = aes( x = Discharge,
y = CDF_manual),
color="darkgreen") +
xlab("Annual Max Discharge (cfs)") +
ylab("CDF(x) or P(x<X)") +
labs(title    = "USGS Stream Discharge Analysis", # Title
subtitle = str_c(station_metadata$station_nm,
" (",
station_metadata$site_no
,")",
sep = ""),
caption = "red shades = AMS, greens shades = PDS")          +
scale_y_continuous(sec.axis = sec_axis(trans = ~ 1 - .,
name="Survival Function = P(x>X)"))
ggplot(data    = ams_series,             # Data Frame
mapping = aes(y  =  Discharge,
x  =  T_manual)) +
xlim(0,max(ams_series$T_manual)) +
theme_bw() +
geom_point(color="red",
data = ams_series,
mapping = aes(y = Discharge,
x = T_manual)) +
geom_line(color="magenta",
data = ams_series,
mapping = aes(y = Discharge,
x = T_gumbel)) +
geom_point(color="darkgreen",
size = 0.75,
data = pds_series,
mapping = aes(y = Discharge,
x = T_manual)) +
xlab("Excedence Frequency (years)") +
ylab("Discharge (cfs)") +
labs(title    = "USGS Stream Discharge Analysis", # Title
subtitle = str_c(station_metadata$station_nm,
" (",
station_metadata$site_no
,")",
sep = ""))
ggplot(data    = ams_series,             # Data Frame
mapping = aes(y  =  Discharge,
x  =  T_manual)) +
theme_bw() +
geom_point(color="red") +
geom_line(color="magenta",
data = ams_series,
mapping = aes(y = Discharge,
x = T_gumbel)) +
geom_point(color="darkgreen",
data = pds_series,
size = 0.75,
mapping = aes(y = Discharge,
x = T_manual)) +
scale_x_log10() +
scale_y_log10() +
xlab("Excedence Frequency (years)") +
ylab("Discharge (cfs)") +
labs(title    = "USGS Stream Discharge Analysis", # Title
subtitle = str_c(station_metadata$station_nm,
" (",
station_metadata$site_no
,")",
sep = ""))
fevd_gum = fevd(x = ams_series$Discharge,
type = "Gumbel",
period.basis="year",
verbose = TRUE)
fevd_gev = fevd(x = ams_series$Discharge,
type = "GEV",
period.basis="year",
verbose = TRUE)
plot(fevd_gev)
ams_series$pdf_gev_extr = devd(x     = ams_series$Discharge,
loc   = fevd_gev$results$par[1],
scale = fevd_gev$results$par[2],
shape = fevd_gev$results$par[3],
type  = "GEV")
ams_series$cdf_gev_extr = pevd(q     = ams_series$Discharge,
loc   = fevd_gev$results$par[1],
scale = fevd_gev$results$par[2],
shape = fevd_gev$results$par[3],
type  = "GEV")
ams_series$pdf_gumbel_extr = evd::dgumbel(x     = ams_series$Discharge,
loc   = fevd_gum$results$par[1],
scale = fevd_gum$results$par[2])
ams_series$cdf_gumbel_extr = evd::pgumbel(q     = ams_series$Discharge,
loc   = fevd_gum$results$par[1],
scale = fevd_gum$results$par[2])
mytib_gumb = tibble(T_gumbel_ext = ams_series$T_manual[ams_series$T_manual > 1],
D_gumbel_ext = return.level(fevd_gum,return.period = ams_series$T_manual[ams_series$T_manual > 1]))
mytib_gev = tibble(T_gev_ext = ams_series$T_manual,
D_gev_ext = return.level(fevd_gev,return.period = ams_series$T_manual[ams_series$T_manual > 1]))
# Plotting the Basic River Discharge Series
ggplot(data    = ams_series,             # Data Frame
mapping = aes(x  =  Discharge)) +
theme_bw() +
geom_density(color = "red") +
geom_line(mapping = aes(y = pdf_gumbel,
x = Discharge),
color = "magenta") +
geom_line(mapping = aes(y = pdf_gumbel_extr,
x = Discharge),
color = "brown") +
geom_line(mapping = aes(y = pdf_gev_extr,
x = Discharge),
color = "purple") +
geom_vline(xintercept = alpha_ams,
color      = "orange") +
labs(title    = "USGS Stream Discharge Analysis", # Title
subtitle = str_c(station_metadata$station_nm,
" (",
station_metadata$site_no
,")",
sep = "")) +
ylab("Probability Density Function, p(x)")            + # Axis Labels
xlab("Discharge (cfs)")
ggplot(data    = ams_series,             # Data Frame
mapping = aes(y  =  Discharge,
x  =  T_manual)) +
scale_x_log10()+scale_y_log10()+
theme_bw() +
geom_point(color="red",
data = ams_series,
mapping = aes(y = Discharge,
x = T_manual)) +
geom_line(color="magenta",
data = ams_series,
mapping = aes(y = Discharge,
x = T_gumbel)) +
geom_line(color="brown",
size = 0.75,
data = mytib_gumb,
mapping = aes(y = D_gumbel_ext,
x = T_gumbel_ext)) +
geom_line(color="purple",
size = 0.75,
data = mytib_gev,
mapping = aes(y = D_gev_ext,
x = T_gev_ext)) +
xlab("Excedence Frequency (years)") +
ylab("Discharge (cfs)") +
labs(title    = "USGS Stream Discharge Analysis", # Title
subtitle = str_c(station_metadata$station_nm,
" (",
station_metadata$site_no
,")",
sep = ""))
mode_daily = mlv(hydrologic$Discharge,
method = "meanshift",
na.rm = TRUE)
mode_ams = mlv(ams_series$Discharge,
method = "meanshift",
na.rm = TRUE)
min_ams = min(ams_series$Discharge)
p99_daily = quantile(hydrologic$Discharge, probs = 0.99, na.rm=TRUE)
p95_daily = quantile(hydrologic$Discharge, probs = 0.95, na.rm=TRUE)
str_c("mode_daily =", mode_daily)
str_c("  mode_ams =", mode_ams)
str_c("   min_ams =", min_ams)
str_c(" p99_daily =", p99_daily)
str_c(" p95_daily =", p95_daily)
# Plotting the Basic River Discharge Series
ggplot(data    = hydrologic,             # Data Frame
mapping = aes(x  =  Date,         # Mapping of Aesthetics
y  =  Discharge)) +
theme_bw() +
geom_line(color = "blue") +
geom_hline(yintercept = mode_daily, color="darkgreen") +
geom_hline(yintercept = mode_ams,   color="red") +
geom_hline(yintercept = p99_daily,  color="pink") +
geom_hline(yintercept = p95_daily,  color="pink") +
geom_point(color   = "red",
data    = ams_series,
mapping = aes(x = Date,
y = Discharge)) +
labs(title    = "USGS Stream Discharge Analysis", # Title
subtitle = str_c(station_metadata$station_nm,
" (",
station_metadata$site_no
,")",
sep = ""),
caption  = "Red = Mode AMS; Gren = Mode Daily; Pinks = 99 & 95 Percentile") +
xlab("Date")            + # Axis Labels
ylab("Discharge (cfs)")
fevd_gp = fevd(x = hydrologic$Discharge,
threshold =  p95_daily,
type = "GP",
period.basis="year",
verbose = TRUE)
mytib_gp = tibble(T_gp_ext = pds_series$T_manual[pds_series$T_manual > 1],
D_gp_ext = return.level(fevd_gp,return.period = pds_series$T_manual[pds_series$T_manual > 1]))
ggplot(data    = ams_series,             # Data Frame
mapping = aes(y  =  Discharge,
x  =  T_manual)) +
theme_bw() +
geom_point(color="red") +
geom_line(color="magenta",
data = ams_series,
mapping = aes(y = Discharge,
x = T_gumbel)) +
geom_line(color="green",
data = mytib_gp,
mapping = aes(y = D_gp_ext,
x = T_gp_ext)) +
geom_line(color="brown",
size = 0.75,
data = mytib_gumb,
mapping = aes(y = D_gumbel_ext,
x = T_gumbel_ext)) +
geom_line(color="purple",
size = 0.75,
data = mytib_gev,
mapping = aes(y = D_gev_ext,
x = T_gev_ext)) +
geom_point(color="darkgreen",
data = pds_series %>% filter(T_manual > 0.7),
size = 0.75,
mapping = aes(y = Discharge,
x = T_manual)) +
scale_x_log10() +
scale_y_log10() +
xlab("Excedence Frequency (years)") +
ylab("Discharge (cfs)") +
labs(title    = "USGS Stream Discharge Analysis", # Title
subtitle = str_c(station_metadata$station_nm,
" (",
station_metadata$site_no
,")",
sep = ""))
station_metadata$station_nm = str_to_title(station_metadata$station_nm)
#metadata_frame              = station_metadata
#metadata_frame = rbind(metadata_frame,station_metadata)
output_frame = ams_series |>
arrange(Water_Year) %>%
select(Date,
Water_Year,
Discharge,
rank,
CDF_manual,
T_manual) %>%
rename("Rank_High_to_Low"=rank,
"Date_of_Event"=Date,
"Emperical_AMS_CDF" = "CDF_manual",
"Emperical_AMS_Return_Period"="T_manual")
write_excel_csv(x = output_frame,
file = str_c("~/Desktop/",station_metadata$station_nm,".csv", sep=""))
#write_excel_csv(x = output_frame,
#               file = str_c("~/Desktop/Inventory.csv", sep=""))
station_metadata$station_nm = str_to_title(station_metadata$station_nm)
#metadata_frame              = station_metadata
#metadata_frame = rbind(metadata_frame,station_metadata)
output_frame = ams_series |>
arrange(Water_Year) %>%
select(Date,
Water_Year,
Discharge,
rank,
CDF_manual,
T_manual) %>%
rename("Rank_High_to_Low"=rank,
"Date_of_Event"=Date,
"Emperical_AMS_CDF" = "CDF_manual",
"Emperical_AMS_Return_Period"="T_manual")
write_excel_csv(x = output_frame,
file = str_c("~/Desktop/",station_metadata$station_nm,".csv", sep=""))
#write_excel_csv(x = output_frame,
#               file = str_c("~/Desktop/Inventory.csv", sep=""))
# Selected Gagues == hey! we can do a lot of them at once!
Station_Targets = c("02087183", # Below Fall Lake
"02087500", # Neuse @ Clinton, NC
"02087570", # Neuse @ Smithfield, NC
"02089000", # Neuse @ Goldsboro, NC
"02089500", # Neuse @ Kinston, NC
"02091814") # Neuse @ Fort Barnwell, NC
# USGS Data Service
data_type_cd = c("dv")
# Statistical Aggregation
stat_cd      = c("00003")
# Parameters
param_cd     = c("00060")
# query NWIS for the metadata
station_metadata = whatNWISdata(siteType    = "ST",            # ST for Station
service     = data_type_cd,    # data type/service
statCd      = stat_cd,         # stats
parameterCd = param_cd,        # parameters
siteNumber  = Station_Targets) # Site_Number for Station
print(station_metadata)
station_metadata$station_nm = str_to_title(station_metadata$station_nm)
#metadata_frame              = station_metadata
#metadata_frame = rbind(metadata_frame,station_metadata)
output_frame = ams_series |>
arrange(Water_Year) %>%
select(Date,
Water_Year,
Discharge,
rank,
CDF_manual,
T_manual) %>%
rename("Rank_High_to_Low"=rank,
"Date_of_Event"=Date,
"Emperical_AMS_CDF" = "CDF_manual",
"Emperical_AMS_Return_Period"="T_manual")
write_excel_csv(x = output_frame,
file = str_c("~/Desktop/",station_metadata$station_nm,".csv", sep=""))
station_metadata = whatNWISdata(siteType    = "ST",            # ST for Station
service     = data_type_cd,    # data type/service
statCd      = stat_cd,         # stats
parameterCd = param_cd,        # parameters
siteNumber  = Station_Targets) # Site_Number for Station
print(station_metadata)
write_excel_csv(x = station_metadata,
file = str_c("~/Desktop/Inventory.csv", sep=""))
